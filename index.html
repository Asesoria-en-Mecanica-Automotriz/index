<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asesoria en Mecanica Automotriz ‚Äî Advisor</title>
  <meta name="description" content="Asesor√≠a mec√°nica automotriz profesional por suscripci√≥n. Toda la atenci√≥n se realiza exclusivamente por WhatsApp del cliente." />
  <meta name="theme-color" content="#0A3D91" />
  <meta property="og:title" content="Asesoria en Mecanica Automotriz ‚Äî Advisor" />
  <meta property="og:description" content="Diagn√≥stico experto 100% por WhatsApp. Planes mensuales y soporte paso a paso." />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Asesoria en Mecanica Automotriz" />

  <!-- Favicon ‚ÄúAM‚Äù embebido (sin archivos extra) -->
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1'%3E%3Cstop stop-color='%23FFC400'/%3E%3Cstop offset='1' stop-color='%23FFD966'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect rx='12' width='64' height='64' fill='%230A3D91'/%3E%3Crect x='6' y='6' width='52' height='52' rx='10' fill='url(%23g)'/%3E%3Ctext x='50%25' y='56%25' text-anchor='middle' font-size='30' font-family='Segoe UI, Roboto, Arial' fill='%231F2937' font-weight='900'%3EAM%3C/text%3E%3C/svg%3E" />

  <style>
    :root{
      --brand:#0A3D91; --brand-2:#0E62FF; --accent:#FFC400; --ink:#0F172A; --muted:#64748B;
      --bg:#F6F8FC; --card:#fff; --ok:#12B886; --shadow:0 10px 30px rgba(2,23,80,.08);
      --radius:18px; --radius-sm:12px; --maxw:1100px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    /* Scroll suave para anclas (#planes) */
    html{scroll-behavior:smooth}

    body{
      margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;
      background: radial-gradient(1200px 600px at 70% -100px,#E8F0FF,transparent 70%),var(--bg);
      color:var(--ink); line-height:1.6;
    }
    .wrap{max-width:var(--maxw);margin:0 auto;padding:24px}

    .ribbon{
      margin:0 0 12px; padding:10px 14px; border-radius:12px; font-weight:700; font-size:14px; color:#0B2B6C;
      background:linear-gradient(180deg,#FFF7D6,#FFE58F); border:1px solid #FFE39C; display:inline-flex; gap:8px; align-items:center;
    }

    header.hero{
      position:relative;border-radius:calc(var(--radius) + 6px);
      background:linear-gradient(120deg,rgba(10,61,145,.95),rgba(14,98,255,.92));
      color:#fff;padding:46px 28px;overflow:hidden; box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .logo{width:42px;height:42px;border-radius:12px;display:grid;place-items:center;
      background:linear-gradient(145deg,var(--accent),#FFD966);color:#1F2937;font-weight:800;box-shadow:inset 0 -4px 10px rgba(0,0,0,.1)}
    h1{font-size:clamp(28px,4.5vw,44px);line-height:1.1;margin:6px 0 10px}
    .lead{font-size:clamp(15px,2.2vw,18px);opacity:.98;max-width:860px}
    .cta{display:flex;flex-wrap:wrap;gap:12px;margin-top:18px}
    .btn{appearance:none;border:0;cursor:pointer;font-weight:800;padding:12px 18px;border-radius:14px;
      display:inline-flex;align-items:center;gap:10px;text-decoration:none;transition:.18s transform,.18s box-shadow,.18s background}
    .btn-primary{background:#fff;color:#0B2B6C;box-shadow:var(--shadow)}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 12px 32px rgba(2,23,80,.12)}
    .btn-ghost{background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.25)}
    .btn-ghost:hover{background:rgba(255,255,255,.20)}
    .badges{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.14);color:#fff;font-size:13px;border:1px solid rgba(255,255,255,.25)}

    main{margin-top:28px}
    section{margin:32px 0}
    .card{background:var(--card);border:1px solid #E6ECF5;border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    .section-title{font-size:clamp(22px,3vw,28px);margin:0 0 14px}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:16px}
    @media(min-width:860px){.grid-3{grid-template-columns:repeat(3,1fr)}.grid-2{grid-template-columns:repeat(2,1fr)}}

    .price-card{position:relative;padding:22px;border-radius:var(--radius);background:linear-gradient(180deg,#fff,#FBFDFF);
      border:1px solid #E8EEF8;transition:.18s transform,.18s box-shadow}
    .price-card:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(2,23,80,.10)}
    .price-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#EEF4FF;color:#0A3D91;border:1px solid #DBE6FF}
    .price{font-size:clamp(24px,3.6vw,30px);font-weight:800;color:var(--ink)}
    .feat{display:flex;align-items:flex-start;gap:10px;margin:8px 0;font-size:15px}
    .check{width:18px;height:18px;border-radius:6px;background:var(--ok);display:inline-grid;place-items:center;color:#fff;font-weight:900;font-size:13px}
    .price-cta{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .btn-outline{background:#fff;color:var(--brand);border:1px solid #D7E3FF}

    /* Bot√≥n seguro y nota de pago */
    .btn-secure::before { content:"üîí"; margin-right:6px }
    .pay-note{ display:block; font-size:12px; color:var(--muted); margin-top:6px }

    /* Tarjetas testimonio */
    .quote{background:#FFFDF4;border:1px solid #FFE39C;border-left:4px solid var(--accent);border-radius:16px;padding:14px}
    .stars{letter-spacing:1px}

    /* ==== Testimonials: grid (desktop) + carousel (mobile) ==== */
    .t-trust-msg{
      text-align:center; margin:16px 0 6px;
      font-weight:800; font-size:200%; color:var(--ink);
      text-decoration-line: underline;
      text-decoration-color:#E03131;
      text-decoration-thickness:3px;
      text-underline-offset:4px;
    }
    .t-trust-title { text-align:center; margin-top:0 }
    .t-carousel{
      display:flex; gap:16px; overflow-x:auto; scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch; padding-bottom:6px; scroll-behavior:smooth;
    }
    .t-slide{ flex:0 0 85%; scroll-snap-align:center }
    .t-carousel::-webkit-scrollbar{ height:8px }
    .t-carousel::-webkit-scrollbar-thumb{ background:#CBD7FF; border-radius:8px }
    @media (min-width:860px){
      .t-carousel{ display:grid; grid-template-columns:repeat(3,1fr); overflow:visible }
      .t-slide{ flex:unset; scroll-snap-align:unset }
    }

    /* ===== Dark mode autom√°tico ===== */
    @media (prefers-color-scheme: dark){
      :root{
        --ink:#E5EAF5; --bg:#0b1220; --card:#0f1a2b; --muted:#94a3b8;
        --brand:#1B63FF; --brand-2:#5491FF; --accent:#FFD24D; --ok:#17D39A;
        --shadow: 0 6px 24px rgba(0,0,0,.45);
      }
      body{ background: radial-gradient(1200px 600px at 70% -100px,#0f1a2b,transparent 70%), var(--bg); }
      header.hero{ background: linear-gradient(120deg, rgba(16,70,180,.96), rgba(14,98,255,.85)); }
      .card{ border-color:#1f2d47; }
      .badge{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18); color:#fff; }
      .btn-outline{ background:#0f1a2b; color:#E5EAF5; border-color:#2a3b5e }
      .quote{ background:#121d31; border-color:#2a3b5e }
      footer{ background: linear-gradient(180deg,#0b1e52,#0b1e52 60%,#0E62FF) }
    }

    footer{margin:40px 0 12px;padding:18px;border-radius:var(--radius);
      background:linear-gradient(180deg,#0A3D91,#0A3D91 60%,#0E62FF);color:#fff}
    footer small a{color:#fff;opacity:.9}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="ribbon">üì£ Atenci√≥n 100% por WhatsApp del cliente ‚Ä¢ Sin apps ni chat web</div>

    <header class="hero" aria-label="Encabezado principal">
      <div class="brand">
        <div class="logo" aria-hidden="true">AM</div>
        <div>
          <div style="font-weight:800;letter-spacing:.2px">Asesoria en Mecanica Automotriz</div>
          <small style="opacity:.9">‚ÄúAdvisor‚Äù ‚Äî Diagn√≥stico experto, paso a paso</small>
        </div>
      </div>
      <h1>Asesor√≠a mec√°nica profesional por suscripci√≥n</h1>
      <p class="lead">
        Todo se atiende exclusivamente por <strong>WhatsApp</strong> desde el n√∫mero del cliente.
        Te guiamos con pruebas OBD2, el√©ctricos, enfriamiento, frenos y m√°s.
      </p>
      <div class="cta">
        <a class="btn btn-primary" id="cta-whatsapp" href="#" rel="noopener">üí¨ Comenzar por WhatsApp</a>
        <a class="btn btn-ghost" href="#planes">Ver planes y precios</a>
      </div>
      <div class="badges" aria-label="Confianza">
        <span class="badge">‚úÖ Cobro seguro con Stripe</span>
        <span class="badge">üîí Datos protegidos</span>
        <span class="badge">üõ†Ô∏è Especialistas 24/7</span>
      </div>
    </header>

    <main>
      <section class="card">
        <h2 class="section-title">C√≥mo funciona</h2>
        <ol>
          <li>Escr√≠benos por WhatsApp desde tu n√∫mero y describe el problema (a√±o, marca, modelo, motor, c√≥digos DTC).</li>
          <li>Un asesor experto te gu√≠a paso a paso con pruebas claras y decisiones concretas.</li>
          <li>Elige un plan mensual. El pago es por Stripe; la atenci√≥n se mantiene siempre en WhatsApp.</li>
        </ol>
        <small class="muted">No usamos chat web ni email para consultas t√©cnicas ‚Äî solo WhatsApp del cliente.</small>
      </section>

     <!-- Bloque: Prueba (3 asesor√≠as gratis en 7 d√≠as) -->
<section class="card">
  <div class="trial" style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between">
    <div>
      <h2 class="section-title" style="margin-bottom:6px">Prueba: 3 asesor√≠as gratis en 7 d√≠as</h2>
      <p class="muted" style="margin:4px 0">
        Incluye hasta <strong>3 asesor√≠as</strong> dentro de los primeros <strong>7 d√≠as</strong>.
        La prueba termina al consumirse las 3 asesor√≠as o al cumplirse los 7 d√≠as, <em>lo que ocurra primero</em>.
        Activaci√≥n por WhatsApp.
      </p>
    </div>
    <a class="btn btn-primary" id="cta-trial" href="#" rel="noopener">‚ú® Probar 3 asesor√≠as (7 d√≠as)</a>
  </div>
</section>

<!-- ===== Mi suscripci√≥n (visible solo si hay customer) ===== -->
<section id="mi-suscripcion" style="display:none; margin:24px 0;">
  <div style="padding:16px; border:1px solid #e5e7eb; border-radius:12px;">
    <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:center; justify-content:space-between;">
      <div id="sub-status" style="font-weight:600;">Tienes una suscripci√≥n activa.</div>
      <div>
        <button id="btn-portal" class="btn btn-outline btn-secure">Gestionar mi suscripci√≥n</button>
        <button id="btn-logout" class="btn" style="margin-left:8px;">Borrar datos locales</button>
      </div>
    </div>
  </div>
</section>

<a id="btn-portal" class="btn btn-outline btn-secure">Administrar mi suscripci√≥n</a>

      
<!-- ========== Planes ========== -->
<section id="planes">
  <h2 class="section-title">Planes y precios</h2>
  <p class="muted" style="margin-top:-6px">
    Elige un plan. Contrataci√≥n y soporte se coordinan por WhatsApp.
    <br><strong>Prueba incluida:</strong> 3 asesor√≠as gratis en 7 d√≠as (lo que ocurra primero).
  </p>

  <div class="grid grid-3" style="margin-top:12px">

    <!-- ===== B√°sico ===== -->
    <article class="price-card">
      <div class="price-h">
        <h3 style="margin:0">B√°sico</h3>
        <span class="pill">Hasta 6 consultas/mes</span>
      </div>
      <div class="price">$399 MXN/mes</div>
      <div class="feat"><span class="check">‚úì</span> Asistencia por WhatsApp</div>
      <div class="feat"><span class="check">‚úì</span> Gu√≠as de diagn√≥stico OBD2 b√°sicas</div>
      <div class="feat"><span class="check">‚úì</span> Revisi√≥n de s√≠ntomas y pruebas r√°pidas</div>

      <div class="price-cta">
        <a class="btn btn-primary wa-plan" data-plan="B√ÅSICO" href="#">Iniciar por WhatsApp</a>
        <a class="btn btn-outline btn-secure btn-pay-stripe"
           data-price-id="price_1SOXlqHDRB00f7scrOHlBbBo"
           href="#">
          Suscribirme al B√°sico
        </a>
      </div>

      <small class="pay-note">Procesado por Stripe ‚Ä¢ Cargo mensual ‚Ä¢ Cancelas cuando quieras</small>
    </article>

    <!-- ===== Avanzado ===== -->
    <article class="price-card" style="border:2px solid #FFB04D">
      <div class="price-h">
        <h3 style="margin:0">Avanzado</h3>
        <span class="pill" style="background:#FFF4D1;color:#8A5B00;border-color:#FFE39C">
          Hasta 10 consultas/mes
        </span>
      </div>
      <div class="price">$499 MXN/mes</div>
      <div class="feat"><span class="check">‚úì</span> Casos el√©ctricos/inyecci√≥n m√°s complejos</div>
      <div class="feat"><span class="check">‚úì</span> Interpretaci√≥n de DTC con pruebas guiadas</div>
      <div class="feat"><span class="check">‚úì</span> Seguimiento priorizado</div>

      <div class="price-cta">
        <a class="btn btn-primary wa-plan" data-plan="AVANZADO" href="#">Iniciar por WhatsApp</a>
        <a class="btn btn-outline btn-secure btn-pay-stripe"
           data-price-id="price_1SOXtLHDRB00f7sc9Kt3ozaN"
           href="#">
          Suscribirme al Avanzado
        </a>
      </div>

      <small class="pay-note">Procesado por Stripe ‚Ä¢ Cargo mensual ‚Ä¢ Cancelas cuando quieras</small>
    </article>

    <!-- ===== PRO ===== -->
    <article class="price-card">
      <div class="price-h">
        <h3 style="margin:0">PRO</h3>
        <span class="pill">Consultas ilimitadas</span>
      </div>
      <div class="price">$999 MXN/mes</div>
      <div class="feat"><span class="check">‚úì</span> Soporte ilimitado mes a mes</div>
      <div class="feat"><span class="check">‚úì</span> Escalamiento a EL M√ÅXIMO EST√ÅNDAR DE RESPUESTA</div>
      <div class="feat"><span class="check">‚úì</span> Historial de casos y mejores pr√°cticas</div>

      <div class="price-cta">
        <a class="btn btn-primary wa-plan" data-plan="PRO" href="#">Iniciar por WhatsApp</a>
        <a class="btn btn-outline btn-secure btn-pay-stripe"
           data-price-id="price_1SOXvxHDRB00f7scXx2DFcOM"
           href="#">
          Activar PRO
        </a>
      </div>

      <small class="pay-note">Procesado por Stripe ‚Ä¢ Cargo mensual ‚Ä¢ Cancelas cuando quieras</small>
    </article>

  </div>

  <small class="muted">
    La autogesti√≥n de cobros y cancelaciones se realiza en el Portal del Cliente.
  </small>
</section>

        
      </div>
      <small class="pay-note">Procesado por Stripe ‚Ä¢ Cargo mensual ‚Ä¢ Cancelas cuando quieras</small>
    </article>
  </div>
  <small class="muted">
    La autogesti√≥n de cobros y cancelaciones se realiza en el
    <a href="#portal" id="portal-link">Portal del Cliente</a>. Las consultas siguen por WhatsApp del cliente.
  </small>
</section>

<!-- ========== Testimonios (secci√≥n separada para evitar desbordes) ========== -->
<section class="card">
  <p class="t-trust-msg">
    "Miles de t√©cnicos, mec√°nicos y autodidactas propietarios de veh√≠culos y de talleres est√°n satisfechos con nuestro gran sistema"
  </p>
  <h3 class="section-title t-trust-title">TESTIMONIOS DE CONFIANZA</h3>

  <div class="t-carousel" id="t-carousel" aria-label="Testimonios">
    <article class="quote t-slide"><div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div><strong>Taller ‚ÄúEl Pist√≥n‚Äù</strong><br>‚ÄúNos resolvieron un P0300 terc@ en menos de 24 h con pruebas claras por WhatsApp.‚Äù</article>
    <article class="quote t-slide"><div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div><strong>Autoel√©ctrico Rivera</strong><br>‚ÄúExcelente gu√≠a para CAN/OBD2. Ahorro de tiempo y piezas. Atenci√≥n siempre en WhatsApp.‚Äù</article>
    <article class="quote t-slide"><div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div><strong>Taller Jalico</strong><br>‚ÄúSeguimiento ordenado y r√°pido. Ideal para equipo en campo: todo por WhatsApp.‚Äù</article>
    <article class="quote t-slide"><div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div><strong>Mec√°nica ‚ÄúLa Chispa‚Äù</strong><br>‚ÄúNos ayudaron a aislar un P0335 con pasos simples. Cero adivinanzas.‚Äù</article>
    <article class="quote t-slide"><div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div><strong>Electromec√°nica G√≥mez</strong><br>‚ÄúInterpretaci√≥n de DTC y pruebas guiadas que funcionan. Muy recomendados.‚Äù</article>
    <article class="quote t-slide"><div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div><strong>Taller de Flotillas Monterrey</strong><br>‚ÄúPara la flotilla fue clave: respuestas r√°pidas y consistentes, 100% por WhatsApp.‚Äù</article>
  </div>
</section>


      <!-- Portal del Cliente (bot√≥n dedicado) -->
      <section class="card" id="portal">
        <h2 class="section-title">Portal del Cliente</h2>
        <p class="muted">Gestiona tu suscripci√≥n, m√©todo de pago y facturas.</p>
        <div class="price-cta">
          <a class="btn btn-outline btn-secure" id="btn-portal" href="YOUR_STRIPE_PORTAL_LINK">Abrir Portal del Cliente</a>
        </div>
        <small class="pay-note">Se abrir√° en una pesta√±a segura. Si ya eres cliente y no te abre, cont√°ctanos por WhatsApp.</small>
      </section>

      <section class="card">
        <h2 class="section-title" style="margin-bottom:6px">Pol√≠tica de reembolsos</h2>
        <p>
          Reembolso total durante los primeros <strong>7 d√≠as</strong> si el servicio no fue utilizado (sin consultas consumidas
          en el periodo). Solic√≠talo en <a href="mailto:soporte@tuCorreo.com">soporte@tuCorreo.com</a>.
          La cancelaci√≥n de cobros es desde el <a href="#portal">Portal del Cliente</a>. La atenci√≥n t√©cnica se mantiene √∫nicamente por WhatsApp.
        </p>
      </section>

      <section class="card">
        <h2 class="section-title">Contacto</h2>
        <p>
          Email: <a href="mailto:soporte@tuCorreo.com">soporte@tuCorreo.com</a><br />
          WhatsApp: <a href="https://wa.me/523112242880" target="_blank" rel="noopener">+52 311 224 2880</a>
        </p>
        <p class="muted" style="margin-top:10px">
          Gracias por tu visita
        </p>
      </section>
    </main>

    <footer>
      <small>¬© 2025 Asesoria en Mecanica Automotriz ‚Äî Advisor ‚Ä¢ <a href="#portal">Portal del Cliente</a></small>
    </footer>
  </div>

  <!-- Stripe.js (para redirectToCheckout si tu backend devuelve sessionId) -->
  
<!-- Stripe (c√°rgalo SOLO una vez) -->
<script src="https://js.stripe.com/v3"></script>

<!-- PARCHE DE DEPURACI√ìN: fuerza e instrumenta el checkout -->
<script>
(function () {
  function log() { console.log('[checkout]', ...arguments); }

  async function startCheckout(priceId) {
    try {
      const ref = localStorage.getItem('ref') || '';
      const url = `${API_BASE}/create-checkout-session`;
      log('POST', url, { priceId, ref });

      const r = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ priceId, ref })
      });

      const j = await r.json();
      log('HTTP', r.status, j);

      if (r.ok && j.url) {
        location.href = j.url;
      } else {
        alert(`No se pudo iniciar el pago (${r.status}): ${j.error || 'sin detalle'}`);
      }
    } catch (e) {
      console.error('Fallo creando la sesi√≥n', e);
      alert('Error de red al crear la sesi√≥n de pago');
    }
  }

  // Enlaza los botones Stripe de la p√°gina
  document.querySelectorAll('.btn-pay-stripe').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();
      const priceId = btn.getAttribute('data-price-id');
      log('click', priceId, btn);
      if (!priceId) return alert('Falta data-price-id');
      startCheckout(priceId);
    }, { passive: false });
  });

  log('parche cargado');
})();
</script>
  
  
<script>
// ====== CONFIG ======
const PHONE    = "523112242880";
const API_BASE = "https://api2-ixy4sbioma-uc.a.run.app";  // sin "/api2"

// Guardar ?ref= si llega en la URL
try {
  const p = new URLSearchParams(location.search);
  const r = p.get('ref'); if (r) localStorage.setItem('ref', r);
} catch (_) {}
</script>

<!-- 1) Post-checkout: si volvemos con ?session_id, leer datos del cliente -->
<script>
(async () => {
  try {
    const params = new URLSearchParams(location.search);
    const sid = params.get('session_id');
    if (sid) {
      const r = await fetch(`${API_BASE}/checkout-session?session_id=${encodeURIComponent(sid)}`);
      const s = await r.json();
      if (s?.customer) {
        localStorage.setItem('stripe_customer_id',     s.customer);
        localStorage.setItem('stripe_subscription_id', s.subscription || '');
        localStorage.setItem('customer_email',         s.customer_email || '');
        console.log('[stripe] customer guardado:', s.customer);
      }
    }
  } catch (e) { console.warn(e); }
})();
</script>

<!-- 2) Parche: crear sesi√≥n de Checkout al clic en los botones .btn-pay-stripe -->
<script>
(() => {
  console.log('[checkout] parche2 cargado');

  // Fallbacks por si el bloque CONFIG no corri√≥ (no deber√≠an activarse si arriba no hay errores)
  window.PHONE    = window.PHONE    || '523112242880';
  window.API_BASE = window.API_BASE || 'https://api2-ixy4sbioma-uc.a.run.app';

  // Helpers
  const $  = (s, c=document) => c.querySelector(s);
  const $$ = (s, c=document) => Array.from(c.querySelectorAll(s));

  async function api(path, payload) {
    const r = await fetch(`${window.API_BASE}/${path}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload || {})
    });
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  }

  function wireStripeButtons() {
    $$('.btn-pay-stripe').forEach(btn => {
      if (btn.__wired) return;
      btn.__wired = true;

      btn.addEventListener('click', async (ev) => {
        ev.preventDefault();
        ev.stopPropagation();

        const priceId = btn.dataset.priceId || btn.getAttribute('data-price-id');
        if (!priceId) {
          alert('Falta priceId en el bot√≥n');
          return;
        }

        try {
          const { url } = await api('create-checkout-session', {
            priceId,
            ref: 'WEBLIVE'
          });
          if (url) location.href = url;
          else alert('No se recibi√≥ URL de Checkout');
        } catch (e) {
          console.error('create-checkout-session fall√≥:', e);
          alert('No se pudo iniciar el pago.');
        }
      }, { passive: false });
    });
  }

  wireStripeButtons();
})();
</script>

<script>
(() => {
  console.log('[checkout] parche3 (guardar customer)');

  // Usa tu backend ya definido en CONFIG/parche2
  const API = (window.API_BASE || 'https://api2-ixy4sbioma-uc.a.run.app').replace(/\/+$/,'');

  const params    = new URLSearchParams(location.search);
  const isSuccess = params.get('success') === 'true';
  const sid       = params.get('session_id');

  // Solo actuamos al volver de Stripe con ?success=true&session_id=...
  if (!isSuccess || !sid) return;

  fetch(`${API}/checkout-session?session_id=${encodeURIComponent(sid)}`)
    .then(r => { if (!r.ok) throw new Error(`HTTP ${r.status}`); return r.json(); })
    .then(data => {
      // Guarda datos √∫tiles para el portal del cliente
      if (data.customer)        localStorage.setItem('stripe_customer_id',       data.customer);
      if (data.subscription)    localStorage.setItem('stripe_subscription_id',   data.subscription);
      if (data.customer_email)  localStorage.setItem('customer_email',           data.customer_email);

      console.log('[stripe] customer guardado:', data.customer);

      // Toast r√°pido (opcional)
      try {
        const t = document.createElement('div');
        t.textContent = '¬°Listo! Suscripci√≥n creada. Redirigiendo‚Ä¶';
        t.style.cssText = 'position:fixed;left:50%;top:18px;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:8px;z-index:99999;font:600 14px/1 system-ui';
        document.body.appendChild(t);
        setTimeout(() => t.remove(), 3500);
      } catch {}

      // Limpia la query y vuelve al home
      const url = new URL(location.href);
      url.search = '';
      setTimeout(() => location.replace(url.toString()), 700);
    })
    .catch(err => console.error('[checkout] no se pudo leer la sesi√≥n:', err));
})();
</script>

<!-- ====== Portal del cliente (Stripe) ====== -->
<script>
(() => {
  const btn = document.getElementById('btn-portal');
  if (!btn) return;

  btn.addEventListener('click', async (e) => {
    e.preventDefault();

    const customerId = localStorage.getItem('stripe_customer_id');
    if (!customerId) {
      alert('Primero activa una suscripci√≥n para poder abrir el portal.');
      return;
    }

    try {
      const r = await fetch(`${API_BASE}/create-portal-session`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ customerId })
      });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const { url } = await r.json();
      if (url) location.href = url;
      else alert('No se pudo abrir el portal del cliente.');
    } catch (err) {
      console.error('[portal]', err);
      alert('Error al abrir el portal del cliente.');
    }
  });
})();
</script>

<script>
// ====== WhatsApp: links reales (blindado) ======
(function () {
  const waHref = (t) => `https://wa.me/${PHONE}?text=${encodeURIComponent(t)}`;

  // CTA principal (hero)
  const cta = document.getElementById("cta-whatsapp");
  if (cta) {
    cta.href = waHref(
      "Hola, quiero comenzar. Mis datos: [Nombre/Taller] [Pa√≠s] [Estado/Regi√≥n] [Ciudad] [A√±o, Marca, Modelo, Motor, C√≥digos/DTC, s√≠ntoma]."
    );
  }

  // CTA de prueba (3 asesor√≠as en 7 d√≠as)
  const trial = document.getElementById("cta-trial");
  if (trial) {
    trial.href = waHref(
      "Solicito PRUEBA: 3 asesor√≠as gratis (7 d√≠as). Mis datos: [Nombre/Taller] [Pa√≠s] [Estado/Regi√≥n] [Ciudad]."
    );
  }

  // Botones de cada plan (B√°sico/Avanzado/PRO)
  document.querySelectorAll(".wa-plan").forEach((btn) => {
    const plan = (btn.getAttribute("data-plan") || "B√ÅSICO").trim();
    btn.href = waHref(
      `Quiero contratar el plan ${plan}. Mis datos: [Nombre/Taller] [Pa√≠s] [Estado/Regi√≥n] [Ciudad]. ` +
      `[A√±o/Marca/Modelo/Motor] [Descripci√≥n del caso / s√≠ntoma].`
    );
  });
})();
</script>

<script>
// ====== Pago con Stripe (v√≠a backend) ======
async function createCheckout(priceId, fallback){
  try{
    const res = await fetch(`${API_BASE}/create-checkout-session`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ priceId, ref: (localStorage.getItem('ref')||'') })
    });
    const data = await res.json();
    if (data && data.url) { location.href = data.url; return; }
    if (fallback && /^https?:\/\//i.test(fallback)) { location.href = fallback; return; }
    alert('No se pudo iniciar el pago.');
  } catch (e){
    console.error(e);
    if (fallback && /^https?:\/\//i.test(fallback)) location.href = fallback;
    else alert('Error de red al crear la sesi√≥n de pago');
  }
}

// Delegaci√≥n: captura TODOS los .btn-pay-stripe aunque muevas el HTML
document.addEventListener('click', (ev)=>{
  const btn = ev.target.closest('.btn-pay-stripe');
  if (!btn) return;
  ev.preventDefault();
  const priceId = (btn.dataset.priceId || '').trim();
  const fallback = (btn.dataset.fallbackUrl || '').trim();
  if (!/^price_/.test(priceId)){
    if (/^https?:\/\//i.test(fallback)) location.href = fallback;
    else alert('Configura un priceId v√°lido en el bot√≥n de pago.');
    return;
  }
  createCheckout(priceId, fallback);
});
</script>


</body>
</html>
