<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Asesoria en Mecanica Automotriz ‚Äî Advisor</title>
  <meta name="description" content="Asesor√≠a mec√°nica automotriz profesional por suscripci√≥n. Toda la atenci√≥n se realiza exclusivamente por WhatsApp del cliente." />
  <meta name="theme-color" content="#0A3D91" />
  <meta property="og:title" content="Asesoria en Mecanica Automotriz ‚Äî Advisor" />
  <meta property="og:description" content="Diagn√≥stico experto 100% por WhatsApp. Planes mensuales y soporte paso a paso." />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Asesoria en Mecanica Automotriz" />

  <!-- Favicon ‚ÄúAM‚Äù embebido (sin archivos extra) -->
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' x2='1'%3E%3Cstop stop-color='%23FFC400'/%3E%3Cstop offset='1' stop-color='%23FFD966'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect rx='12' width='64' height='64' fill='%230A3D91'/%3E%3Crect x='6' y='6' width='52' height='52' rx='10' fill='url(%23g)'/%3E%3Ctext x='50%25' y='56%25' text-anchor='middle' font-size='30' font-family='Segoe UI, Roboto, Arial' fill='%231F2937' font-weight='900'%3EAM%3C/text%3E%3C/svg%3E" />

  <style>
    :root{
      --brand:#0A3D91; --brand-2:#0E62FF; --accent:#FFC400; --ink:#0F172A; --muted:#64748B;
      --bg:#F6F8FC; --card:#fff; --ok:#12B886; --shadow:0 10px 30px rgba(2,23,80,.08);
      --radius:18px; --radius-sm:12px; --maxw:1100px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    /* Scroll suave para anclas (#planes) */
    html{scroll-behavior:smooth}

    body{
      margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial;
      background: radial-gradient(1200px 600px at 70% -100px,#E8F0FF,transparent 70%),var(--bg);
      color:var(--ink); line-height:1.6;
    }
    .wrap{max-width:var(--maxw);margin:0 auto;padding:24px}

    .ribbon{
      margin:0 0 12px; padding:10px 14px; border-radius:12px; font-weight:700; font-size:14px; color:#0B2B6C;
      background:linear-gradient(180deg,#FFF7D6,#FFE58F); border:1px solid #FFE39C; display:inline-flex; gap:8px; align-items:center;
    }

    header.hero{
      position:relative;border-radius:calc(var(--radius) + 6px);
      background:linear-gradient(120deg,rgba(10,61,145,.95),rgba(14,98,255,.92));
      color:#fff;padding:46px 28px;overflow:hidden; box-shadow:var(--shadow);
    }
    .brand{display:flex;align-items:center;gap:12px;margin-bottom:10px}
    .logo{width:42px;height:42px;border-radius:12px;display:grid;place-items:center;
      background:linear-gradient(145deg,var(--accent),#FFD966);color:#1F2937;font-weight:800;box-shadow:inset 0 -4px 10px rgba(0,0,0,.1)}
    h1{font-size:clamp(28px,4.5vw,44px);line-height:1.1;margin:6px 0 10px}
    .lead{font-size:clamp(15px,2.2vw,18px);opacity:.98;max-width:860px}
    .cta{display:flex;flex-wrap:wrap;gap:12px;margin-top:18px}
    .btn{appearance:none;border:0;cursor:pointer;font-weight:800;padding:12px 18px;border-radius:14px;
      display:inline-flex;align-items:center;gap:10px;text-decoration:none;transition:.18s transform,.18s box-shadow,.18s background}
    .btn-primary{background:#fff;color:#0B2B6C;box-shadow:var(--shadow)}
    .btn-primary:hover{transform:translateY(-1px);box-shadow:0 12px 32px rgba(2,23,80,.12)}
    .btn-ghost{background:rgba(255,255,255,.12);color:#fff;border:1px solid rgba(255,255,255,.25)}
    .btn-ghost:hover{background:rgba(255,255,255,.20)}
    .badges{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
      background:rgba(255,255,255,.14);color:#fff;font-size:13px;border:1px solid rgba(255,255,255,.25)}

    main{margin-top:28px}
    section{margin:32px 0}
    .card{background:var(--card);border:1px solid #E6ECF5;border-radius:var(--radius);padding:18px;box-shadow:var(--shadow)}
    .section-title{font-size:clamp(22px,3vw,28px);margin:0 0 14px}
    .muted{color:var(--muted)}
    .grid{display:grid;gap:16px}
    @media(min-width:860px){.grid-3{grid-template-columns:repeat(3,1fr)}.grid-2{grid-template-columns:repeat(2,1fr)}}

    .price-card{position:relative;padding:22px;border-radius:var(--radius);background:linear-gradient(180deg,#fff,#FBFDFF);
      border:1px solid #E8EEF8;transition:.18s transform,.18s box-shadow}
    .price-card:hover{transform:translateY(-2px);box-shadow:0 12px 40px rgba(2,23,80,.10)}
    .price-h{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;background:#EEF4FF;color:#0A3D91;border:1px solid #DBE6FF}
    .price{font-size:clamp(24px,3.6vw,30px);font-weight:800;color:var(--ink)}
    .feat{display:flex;align-items:flex-start;gap:10px;margin:8px 0;font-size:15px}
    .check{width:18px;height:18px;border-radius:6px;background:var(--ok);display:inline-grid;place-items:center;color:#fff;font-weight:900;font-size:13px}
    .price-cta{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    .btn-outline{background:#fff;color:var(--brand);border:1px solid #D7E3FF}

    /* Bot√≥n seguro y nota de pago */
    .btn-secure::before { content:"üîí"; margin-right:6px }
    .pay-note{ display:block; font-size:12px; color:var(--muted); margin-top:6px }

    /* Tarjetas testimonio */
    .quote{background:#FFFDF4;border:1px solid #FFE39C;border-left:4px solid var(--accent);border-radius:16px;padding:14px}
    .stars{letter-spacing:1px}

    /* ==== Testimonials: grid (desktop) + carousel (mobile) ==== */
    .t-trust-msg{
      text-align:center; margin:16px 0 6px;
      font-weight:800; font-size:200%; color:var(--ink);
      text-decoration-line: underline;
      text-decoration-color:#E03131;
      text-decoration-thickness:3px;
      text-underline-offset:4px;
    }
    .t-trust-title { text-align:center; margin-top:0 }
    .t-carousel{
      display:flex; gap:16px; overflow-x:auto; scroll-snap-type:x mandatory;
      -webkit-overflow-scrolling:touch; padding-bottom:6px; scroll-behavior:smooth;
    }
    .t-slide{ flex:0 0 85%; scroll-snap-align:center }
    .t-carousel::-webkit-scrollbar{ height:8px }
    .t-carousel::-webkit-scrollbar-thumb{ background:#CBD7FF; border-radius:8px }
    @media (min-width:860px){
      .t-carousel{ display:grid; grid-template-columns:repeat(3,1fr); overflow:visible }
      .t-slide{ flex:unset; scroll-snap-align:unset }
    }

    /* ===== Dark mode autom√°tico ===== */
    @media (prefers-color-scheme: dark){
      :root{
        --ink:#E5EAF5; --bg:#0b1220; --card:#0f1a2b; --muted:#94a3b8;
        --brand:#1B63FF; --brand-2:#5491FF; --accent:#FFD24D; --ok:#17D39A;
        --shadow: 0 6px 24px rgba(0,0,0,.45);
      }
      body{ background: radial-gradient(1200px 600px at 70% -100px,#0f1a2b,transparent 70%), var(--bg); }
      header.hero{ background: linear-gradient(120deg, rgba(16,70,180,.96), rgba(14,98,255,.85)); }
      .card{ border-color:#1f2d47; }
      .badge{ background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18); color:#fff; }
      .btn-outline{ background:#0f1a2b; color:#E5EAF5; border-color:#2a3b5e }
      .quote{ background:#121d31; border-color:#2a3b5e }
      footer{ background: linear-gradient(180deg,#0b1e52,#0b1e52 60%,#0E62FF) }
    }

    footer{margin:40px 0 12px;padding:18px;border-radius:var(--radius);
      background:linear-gradient(180deg,#0A3D91,#0A3D91 60%,#0E62FF);color:#fff}
    footer small a{color:#fff;opacity:.9}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="ribbon">üì£ Atenci√≥n 100% por WhatsApp del cliente ‚Ä¢ Sin apps ni chat web</div>

    <header class="hero" aria-label="Encabezado principal">
      <div class="brand">
        <div class="logo" aria-hidden="true">AM</div>
        <div>
          <div style="font-weight:800;letter-spacing:.2px">Asesoria en Mecanica Automotriz</div>
          <small style="opacity:.9">‚ÄúAdvisor‚Äù ‚Äî Diagn√≥stico experto, paso a paso</small>
        </div>
      </div>
      <h1>Asesor√≠a mec√°nica profesional por suscripci√≥n</h1>
      <p class="lead">
        Todo se atiende exclusivamente por <strong>WhatsApp</strong> desde el n√∫mero del cliente.
        Te guiamos con pruebas OBD2, el√©ctricos, enfriamiento, frenos y m√°s.
      </p>
      <div class="cta">
        <a class="btn btn-primary" id="cta-whatsapp" href="#" rel="noopener">üí¨ Comenzar por WhatsApp</a>
        <a class="btn btn-ghost" href="#planes">Ver planes y precios</a>
      </div>
      <div class="badges" aria-label="Confianza">
        <span class="badge">‚úÖ Cobro seguro con Stripe</span>
        <span class="badge">üîí Datos protegidos</span>
        <span class="badge">üõ†Ô∏è Especialistas 24/7</span>
      </div>
    </header>

    <main>
      <section class="card">
        <h2 class="section-title">C√≥mo funciona</h2>
        <ol>
          <li>Escr√≠benos por WhatsApp desde tu n√∫mero y describe el problema (a√±o, marca, modelo, motor, c√≥digos DTC).</li>
          <li>Un asesor experto te gu√≠a paso a paso con pruebas claras y decisiones concretas.</li>
          <li>Elige un plan mensual. El pago es por Stripe; la atenci√≥n se mantiene siempre en WhatsApp.</li>
        </ol>
        <small class="muted">No usamos chat web ni email para consultas t√©cnicas ‚Äî solo WhatsApp del cliente.</small>
      </section>

      <!-- Bloque: 7 d√≠as gratis (WhatsApp) -->
      <section class="card">
        <div class="trial" style="display:flex;flex-wrap:wrap;gap:12px;align-items:center;justify-content:space-between">
          <div>
            <h2 class="section-title" style="margin-bottom:6px">Probar 7 d√≠as gratis</h2>
            <p class="muted" style="margin:4px 0">Act√≠valo por WhatsApp. Sujeto a disponibilidad. Atenci√≥n dentro del horario operativo.</p>
          </div>
          <a class="btn btn-primary" id="cta-trial" href="#" rel="noopener">‚ú® Probar 7 d√≠as por WhatsApp</a>
        </div>
      </section>

      <!-- Planes -->
      <section id="planes">
        <h2 class="section-title">Planes y precios</h2>
        <p class="muted" style="margin-top:-6px">Elige un plan. Contrataci√≥n y soporte se coordinan por WhatsApp.</p>
        <div class="grid grid-3" style="margin-top:12px">
          <!-- B√°sico -->
          <article class="price-card">
            <div class="price-h">
              <h3 style="margin:0">B√°sico</h3>
              <span class="pill">Hasta 6 consultas/mes</span>
            </div>
            <div class="price">$399 MXN/mes</div>
            <div class="feat"><span class="check">‚úì</span> Asistencia por WhatsApp</div>
            <div class="feat"><span class="check">‚úì</span> Gu√≠as de diagn√≥stico OBD2 b√°sicas</div>
            <div class="feat"><span class="check">‚úì</span> Revisi√≥n de s√≠ntomas y pruebas r√°pidas</div>
            <div class="price-cta">
             <a class="btn btn-outline btn-secure btn-pay-stripe"
   data-price-id="price_basic_placeholder"
   data-fallback-url="https://checkout.stripe.com/c/pay/XXXXXXXX"
   href="https://checkout.stripe.com/c/pay/XXXXXXXX"
   aria-label="Suscribirme al plan B√°sico por $399 MXN al mes. Pago seguro con tarjeta, procesado por Stripe.">
   Suscribirme al B√°sico
</a>

            </div>
            <small class="pay-note">Procesado por Stripe ‚Ä¢ Cargo mensual ‚Ä¢ Cancelas cuando quieras</small>
          </article>

          <!-- Avanzado -->
          <article class="price-card" style="border:2px solid #FFD04D">
            <div class="price-h">
              <h3 style="margin:0">Avanzado</h3>
              <span class="pill" style="background:#FFF4D1;color:#8A5800;border-color:#FFE39C">Hasta 10 consultas/mes</span>
            </div>
            <div class="price">$499 MXN/mes</div>
            <div class="feat"><span class="check">‚úì</span> Casos el√©ctricos e inyecci√≥n m√°s complejos</div>
            <div class="feat"><span class="check">‚úì</span> Interpretaci√≥n de DTC con pruebas guiadas</div>
            <div class="feat"><span class="check">‚úì</span> Seguimiento priorizado</div>
            <div class="price-cta">
              <a class="btn btn-primary wa-plan" data-plan="AVANZADO" href="#">Iniciar por WhatsApp</a>
              <a class="btn btn-outline btn-secure btn-pay-stripe"
                 data-price-id="price_1SEO1vHhTrAfLf1ezReW7mFu"
                 data-fallback-url="YOUR_STRIPE_CHECKOUT_LINK_ADVANCED"
                 href="YOUR_STRIPE_CHECKOUT_LINK_ADVANCED"
                 aria-label="Suscribirme al plan Avanzado por $499 MXN al mes. Pago seguro con tarjeta, procesado por Stripe.">
                 Suscribirme al Avanzado
              </a>
            </div>
            <small class="pay-note">Procesado por Stripe ‚Ä¢ Cargo mensual ‚Ä¢ Cancelas cuando quieras</small>
          </article>

          <!-- PRO -->
          <article class="price-card">
            <div class="price-h">
              <h3 style="margin:0">PRO</h3>
              <span class="pill">Consultas ilimitadas</span>
            </div>
            <div class="price">$999 MXN/mes</div>
            <div class="feat"><span class="check">‚úì</span> Soporte ilimitado mes a mes</div>
            <div class="feat"><span class="check">‚úì</span> Escalamiento a asesor experto humano</div>
            <div class="feat"><span class="check">‚úì</span> Historial de casos y mejores pr√°cticas</div>
            <div class="price-cta">
              <a class="btn btn-primary wa-plan" data-plan="PRO" href="#">Iniciar por WhatsApp</a>
              <a class="btn btn-outline btn-secure btn-pay-stripe"
                 data-price-id="price_1SENdDHhTrAfLf1eTnywP9m6"
                 data-fallback-url="YOUR_STRIPE_CHECKOUT_LINK_PRO"
                 href="YOUR_STRIPE_CHECKOUT_LINK_PRO"
                 aria-label="Activar plan PRO por $999 MXN al mes. Pago seguro con tarjeta, procesado por Stripe.">
                 Activar PRO
              </a>
            </div>
            <small class="pay-note">Procesado por Stripe ‚Ä¢ Cargo mensual ‚Ä¢ Cancelas cuando quieras</small>
          </article>
        </div>

        <small class="muted">
          La autogesti√≥n de cobros y cancelaciones se realiza en el
          <a href="#portal" id="portal-link">Portal del Cliente</a>. Las consultas siguen por WhatsApp del cliente.
        </small>

        <!-- Confianza + Testimonios (6) -->
        <p class="t-trust-msg">
          "Miles de tecnicos, mecanicos y autodidactas propietarios de vehiculos y de talleres estan satisfechos con nuestro gran sistema"
        </p>
        <h3 class="section-title t-trust-title">TESTIMONIOS DE CONFIANZA</h3>

        <section class="t-carousel" id="t-carousel" aria-label="Testimonios">
          <article class="quote t-slide">
            <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
            <strong>Taller ‚ÄúEl Pist√≥n‚Äù</strong><br/>
            ‚ÄúNos resolvieron un P0300 terc@ en menos de 24 h con pruebas claras por WhatsApp.‚Äù
          </article>

          <article class="quote t-slide">
            <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
            <strong>Autoel√©ctrico Rivera</strong><br/>
            ‚ÄúExcelente gu√≠a para CAN/OBD2. Ahorro de tiempo y piezas. Atenci√≥n siempre en WhatsApp.‚Äù
          </article>

          <article class="quote t-slide">
            <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
            <strong>Taller Jalico</strong><br/>
            ‚ÄúSeguimiento ordenado y r√°pido. Ideal para equipo en campo: todo por WhatsApp.‚Äù
          </article>

          <article class="quote t-slide">
            <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
            <strong>Mec√°nica ‚ÄúLa Chispa‚Äù</strong><br/>
            ‚ÄúNos ayudaron a aislar un P0335 con pasos simples. Cero adivinanzas, todo por WhatsApp.‚Äù
          </article>

          <article class="quote t-slide">
            <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
            <strong>Electromec√°nica G√≥mez</strong><br/>
            ‚ÄúInterpretaci√≥n de DTC y pruebas guiadas que realmente funcionan. Muy recomendados.‚Äù
          </article>

          <article class="quote t-slide">
            <div class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>
            <strong>Taller de Flotillas Monterrey</strong><br/>
            ‚ÄúPara la flotilla fue clave: respuestas r√°pidas y consistentes, 100% por WhatsApp a cualquier hora 24/7.‚Äù
          </article>
        </section>
      </section>

      <!-- Portal del Cliente (bot√≥n dedicado) -->
      <section class="card" id="portal">
        <h2 class="section-title">Portal del Cliente</h2>
        <p class="muted">Gestiona tu suscripci√≥n, m√©todo de pago y facturas.</p>
        <div class="price-cta">
          <a class="btn btn-outline btn-secure" id="btn-portal" href="YOUR_STRIPE_PORTAL_LINK">Abrir Portal del Cliente</a>
        </div>
        <small class="pay-note">Se abrir√° en una pesta√±a segura. Si ya eres cliente y no te abre, cont√°ctanos por WhatsApp.</small>
      </section>

      <section class="card">
        <h2 class="section-title" style="margin-bottom:6px">Pol√≠tica de reembolsos</h2>
        <p>
          Reembolso total durante los primeros <strong>7 d√≠as</strong> si el servicio no fue utilizado (sin consultas consumidas
          en el periodo). Solic√≠talo en <a href="mailto:soporte@tuCorreo.com">soporte@tuCorreo.com</a>.
          La cancelaci√≥n de cobros es desde el <a href="#portal">Portal del Cliente</a>. La atenci√≥n t√©cnica se mantiene √∫nicamente por WhatsApp.
        </p>
      </section>

      <section class="card">
        <h2 class="section-title">Contacto</h2>
        <p>
          Email: <a href="mailto:soporte@tuCorreo.com">soporte@tuCorreo.com</a><br />
          WhatsApp: <a href="https://wa.me/523112242880" target="_blank" rel="noopener">+52 311 224 2880</a>
        </p>
        <p class="muted" style="margin-top:10px">
          Gracias por tu visita
        </p>
      </section>
    </main>

    <footer>
      <small>¬© 2025 Asesoria en Mecanica Automotriz ‚Äî Advisor ‚Ä¢ <a href="#portal">Portal del Cliente</a></small>
    </footer>
  </div>

  <!-- Stripe.js (para redirectToCheckout si tu backend devuelve sessionId) -->
  <script src="https://js.stripe.com/v3"></script>

  <script>
    // ======= CONFIG FRONTEND =======
    const PHONE = "523112242880"; // MX +52 311 224 2880
    const API_BASE = "https://api2-ixy4sbioma-uc.a.run.app.cloudfunctions.net/api"; // ‚Üê tu backend (Firebase Functions o Node)
    const STRIPE_PK = ""; // opcional: 'pk_live_...' si quieres usar redirectToCheckout con sessionId

    // ======= Helpers =======
    function waHref(text){ return `https://wa.me/${PHONE}?text=${encodeURIComponent(text)}`; }

    // Captura y persiste el c√≥digo de referido (?ref=)
    function captureRef() {
      try {
        const p = new URLSearchParams(location.search);
        const r = p.get('ref');
        if (r) localStorage.setItem('ref', r);
        return localStorage.getItem('ref') || '';
      } catch (_) { return ''; }
    }
    const REF_CODE = captureRef();

    // ======= CTA WhatsApp =======
    const cta = document.getElementById('cta-whatsapp');
    if(cta){ cta.href = waHref("Hola, quiero comenzar. Mis datos: [A√±o, Marca, Modelo, Motor, C√≥digos DTC]."); }

    const trial = document.getElementById('cta-trial');
    if(trial){ trial.href = waHref("Solicito PRUEBA 7 DIAS gratis. Mis datos: [Nombre/Taller] [Ciudad]."); }

    document.querySelectorAll('.wa-plan').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        const plan = btn.dataset.plan || "B√ÅSICO";
        const msg = `Quiero contratar el plan ${plan}. Mis datos: [Nombre/Taller] [A√±o/Marca/Modelo/Motor] [Descripci√≥n del caso].`;
        window.location.href = waHref(msg);
      });
    });

    // ======= Pago con Stripe (v√≠a backend) =======
    const stripe = (STRIPE_PK && /^pk_/.test(STRIPE_PK)) ? Stripe(STRIPE_PK) : null;

    async function createCheckout(priceId, fallbackUrl){
      // Si no hay backend configurado, usa fallback
      if (!API_BASE || API_BASE.includes('<PROJECT>')) {
        if (fallbackUrl && fallbackUrl.startsWith('http')) window.location.href = fallbackUrl;
        else alert('Configura API_BASE o el enlace directo de Stripe.');
        return;
      }
      try {
        const res = await fetch(`${API_BASE}/create-checkout-session`, {
          method: 'POST', headers: { 'Content-Type':'application/json' },
          body: JSON.stringify({ priceId, ref: REF_CODE })
        });
        const data = await res.json();
        if (data.url) { window.location.href = data.url; return; }
        if (data.id && stripe) {
          const { error } = await stripe.redirectToCheckout({ sessionId: data.id });
          if (error) alert(error.message);
        } else if (fallbackUrl) {
          window.location.href = fallbackUrl;
        } else {
          alert('No se pudo iniciar el pago.');
        }
      } catch (err) {
        console.error(err);
        if (fallbackUrl) window.location.href = fallbackUrl; else alert('Error de red al crear la sesi√≥n de pago');
      }
    }

    document.querySelectorAll('.btn-pay-stripe').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        e.preventDefault();
        const priceId = btn.dataset.priceId;
        const fallback = btn.dataset.fallbackUrl || btn.getAttribute('href');
        if (!priceId || priceId.includes('placeholder')) {
          if (fallback) window.location.href = fallback; else alert('Configura los priceId o el enlace de Stripe.');
          return;
        }
        createCheckout(priceId, fallback);
      });
    });

    // ======= Portal del Cliente =======
    async function hydrateFromSession(){
      // Si llegamos de success_url con session_id, intenta guardar el customer en localStorage
      const p = new URLSearchParams(location.search);
      const sid = p.get('session_id');
      if (!sid) return;
      if (!API_BASE || API_BASE.includes('<PROJECT>')) return;
      try{
        const r = await fetch(`${API_BASE}/checkout-session?session_id=${encodeURIComponent(sid)}`);
        const data = await r.json();
        if (data && data.customer) localStorage.setItem('stripe_customer_id', data.customer);
      }catch(e){ console.error('hydrateFromSession', e); }
    }

    async function openPortal(){
      const fallback = document.getElementById('btn-portal')?.getAttribute('href');
      // Si no hay backend, cae al fallback
      if (!API_BASE || API_BASE.includes('<PROJECT>')) {
        if (fallback && !fallback.includes('YOUR_STRIPE_PORTAL_LINK')) window.location.href = fallback; else alert('Escr√≠benos por WhatsApp para tu enlace de portal.');
        return;
      }
      try{
        const customerId = localStorage.getItem('stripe_customer_id') || '';
        const r = await fetch(`${API_BASE}/create-portal-session`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(customerId ? { customerId } : {})
        });
        const data = await r.json();
        if (data.url) { window.location.href = data.url; return; }
        // Si backend requiere customerId y no lo tiene
        if (fallback && !fallback.includes('YOUR_STRIPE_PORTAL_LINK')) window.location.href = fallback;
        else alert('No encontramos tu sesi√≥n. Si ya eres cliente, escr√≠benos por WhatsApp y te enviamos tu enlace.');
      }catch(e){
        console.error('openPortal', e);
        if (fallback && !fallback.includes('YOUR_STRIPE_PORTAL_LINK')) window.location.href = fallback;
        else alert('No pudimos abrir tu portal ahora.');
      }
    }

    document.getElementById('btn-portal')?.addEventListener('click', (e)=>{ e.preventDefault(); openPortal(); });
    hydrateFromSession();

    // ======= Carrusel: sin salto; autoplay solo si es visible (>=50%) =======
    (function(){
      const track = document.getElementById('t-carousel');
      if(!track) return;
      const slides = Array.from(track.children);
      let idx = 0; let playing = false;
      const mqlDesktop = matchMedia('(min-width: 860px)');
      const mqlReduce  = matchMedia('(prefers-reduced-motion: reduce)');
      const isDesktop = () => mqlDesktop.matches;
      track.scrollLeft = 0;
      function next(){
        if(isDesktop() || !playing || mqlReduce.matches) return;
        idx = (idx + 1) % slides.length;
        slides[idx].scrollIntoView({behavior:'smooth', inline:'center'});
      }
      setInterval(next, 3500);
      track.addEventListener('pointerenter', ()=>{ playing = false; });
      track.addEventListener('pointerleave', ()=>{ if(isInView(track)) playing = true; });
      function isInView(el){
        const r = el.getBoundingClientRect();
        const vh = window.innerHeight || document.documentElement.clientHeight;
        return r.top < vh*0.5 && r.bottom > vh*0.5;
      }
      if('IntersectionObserver' in window){
        const io = new IntersectionObserver((entries)=>{
          entries.forEach(entry=>{ playing = entry.isIntersecting && entry.intersectionRatio >= 0.5; });
        }, {threshold:[0.5]});
        io.observe(track);
      } else {
        const onScroll = ()=>{ playing = isInView(track); };
        window.addEventListener('scroll', onScroll, {passive:true});
        onScroll();
      }
    })();
  </script>
</body>
</html>
